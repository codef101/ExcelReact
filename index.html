<html>

<head>
    <title>React Fancy Table Learner</title>
</head>

<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.js"></script>

    <script type="text/babel">

        const headers = ['Book', 'Author', 'Language', 'Published', 'Sales'];
        const data = [
            [
                'A Tale of Two Cities', 'Charles Dickens',
                'English', '1859', '200 million',
            ],
            [
                'Le Petit Prince (The Little Prince)', 'Antoine de Saint-ExupÃ©ry',
                'French', '1943', '150 million',
            ],
            [
                "Harry Potter and the Philosopher's Stone", 'J. K. Rowling',
                'English', '1997', '120 million',
            ],
            [
                'And Then There Were None', 'Agatha Christie',
                'English', '1939', '100 million',
            ],
            [
                'Dream of the Red Chamber', 'Cao Xueqin',
                'Chinese', '1791', '100 million',
            ],
            [
                'The Hobbit', 'J. R. R. Tolkien',
                'English', '1937', '100 million',
            ],
        ];

        function clone(o) {
            return JSON.parse(JSON.stringify(o));
        }

        class Excel extends React.Component {
            constructor(props) {
                super();
                const data = clone(props.initialData).map((row, idx) =>
                    row.concat(idx),
                );
                this.state = {
                    data,
                    sortby: null,
                    descending: false,
                    edit: null, // {row: index, column: index}
                    search: false,
                };
                this.log = [clone(this.state)];
                this.replay = this.replay.bind(this);
                this.replayID = null;
                this.logSetState = this.logSetState.bind(this);
                this.preSearchData = null;
                this.sort = this.sort.bind(this);
                this.showEditor = this.showEditor.bind(this);
                this.save = this.save.bind(this);
                this.toggleSearch = this.toggleSearch.bind(this);
                this.search = this.search.bind(this);
                this.keydownHandler = this.keydownHandler.bind(this);

                this.downloadJSON = this.download.bind(this, 'json');
                this.downloadCSV = this.download.bind(this, 'csv');
            }

            componentDidMount() {
                document.addEventListener('keydown', this.keydownHandler);
            }

            componentDidMount() {
                document.addEventListener('keydown', this.keydownHandler);
                clearInterval(this.replayID);
            }

            replay() {
                if (this.log.length === 1) {
                    console.warn('No state changes to replay yet');
                    return;
                }
                let idx = -1;
                const interval = setInterval(() => {
                    if (++idx === this.log.length - 1) {
                        // the end
                        clearInterval(interval);
                    }
                    this.setState(this.log[idx]);
                }, 1000);
            }
            clearInterval(e) {
                this.replayID = setInterval(() => {
                    if (++idx === this.log.length - 1) {
                        // the end
                        clearInterval(this.replayID);
                    }
                    this.setState(this.log[idx]);
                }, 1000);
            }
            keydownHandler(e) {
                if (e.altKey && e.shiftKey && e.keyCode === 82) {
                    // ALT+SHIFT+R(eplay)
                    this.replay();
                }
            }
            logSetState(newState) {
                // remember the old state in a clone
                this.log.push(clone(newState));
                // now set it
                this.setState(newState);
            }
            sort(e) {
                console.log('sorting....')

                const column = e.target.cellIndex;
                const data = clone(this.state.data);
                const descending = this.state.sortby === column && !this.state.descending;

                data.sort((a, b) => {
                    console.log('a column', a[column])
                    console.log('b column', b[column])
                    if (a[column] === b[column]) {
                        return 0;
                    }
                    return descending
                        ? a[column] < b[column]
                            ? 1
                            : -1
                        : a[column] > b[column]
                            ? 1
                            : -1;
                });

                this.setState({
                    data,
                    sortby: column,
                    descending,
                });
            }

            showEditor(e) {
                this.setState({
                    edit: {
                        row: parseInt(e.target.parentNode.dataset.row, 10),
                        column: e.target.cellIndex,
                    },
                });
            }

            save(e) {
                e.preventDefault();
                const input = e.target.firstChild;
                const data = clone(this.state.data).map((row) => {
                    if (row[row.length - 1] === this.state.edit.row) {
                        row[this.state.edit.column] = input.value;
                    }
                    return row;
                });
                this.logSetState({
                    edit: null,
                    data,
                });
                if (this.preSearchData) {
                    this.preSearchData[this.state.edit.row][this.state.edit.column] =
                        input.value;
                }
            }

            toggleSearch() {
                if (this.state.search) {
                    this.setState({
                        data: this.preSearchData,
                        search: false,
                    });
                    this.preSearchData = null;
                } else {
                    this.preSearchData = this.state.data;
                    this.setState({
                        search: true,
                    });
                }
            }

            search(e) {
                const needle = e.target.value.toLowerCase();
                if (!needle) {
                    this.setState({ data: this.preSearchData });
                    return;
                }
                const idx = e.target.dataset.idx;
                const searchdata = this.preSearchData.filter((row) => {
                    return row[idx].toString().toLowerCase().indexOf(needle) > -1;
                });
                this.setState({ data: searchdata });
            }

            download(format, ev) {
                const data = clone(this.state.data).map(row => {
                    row.pop(); // drop the last column, the recordId
                    return row;
                });
                const contents =
                    format === 'json'
                        ? JSON.stringify(data, null, ' ')
                        : data.reduce((result, row) => {
                            return (
                                result +
                                row.reduce((rowcontent, cellcontent, idx) => {
                                    const cell = cellcontent.replace(/"/g, '""');
                                    const delimiter = idx < row.length - 1 ? ',' : '';
                                    return `${rowcontent}"${cellcontent}"${delimiter}`;
                                }, '') +
                                '\n'
                            );
                        }, '');
                const URL = window.URL || window.webkitURL;
                const blob = new Blob([contents], { type: 'text/' + format });
                ev.target.href = URL.createObjectURL(blob);
                ev.target.download = 'data.' + format;
            }

            render() {
                const headers = [];
                const searchRow = !this.state.search ? null : (
                    <tr onChange={this.search}>
                        {this.props.headers.map((_, idx) => (
                            <td key={idx}>
                                <input type="text" data-idx={idx} />
                            </td>
                        ))}
                    </tr>
                );
                return (
                    <div>
                        <div className="toolbar">
                            <button onClick={this.toggleSearch}>
                                {this.state.search ? 'Hide search' : 'Show search'}
                            </button>
                            <a href="data.json" onClick={this.downloadJSON}>
                                Export JSON
                            </a>
                            <a href="data.csv" onClick={this.downloadCSV}>
                                Export CSV
                            </a>
                        </div>
                        <table>
                            <thead>
                                <tr onClick={this.sort}>
                                    {this.props.headers.map((title, idx) => {
                                        if (this.state.sortby === idx) {
                                            title += this.state.descending ? ' \u2191' : ' \u2193'
                                        }
                                        return <th key={idx}>{title}</th>
                                    })}
                                </tr>
                            </thead>

                            <tbody onDoubleClick={this.showEditor}>
                                {searchRow}
                                {this.state.data.map((row, rowidx) => {
                                    const recordId = row[row.length - 1];

                                    return (
                                        <tr key={recordId} data-row={recordId}>
                                            {row.map((cell, columnidx) => {
                                                if (columnidx === this.props.headers.length) {
                                                    // do not show the record ID in the table UI
                                                    return;
                                                }
                                                const edit = this.state.edit;
                                                if (
                                                    edit &&
                                                    edit.row === recordId &&
                                                    edit.column === columnidx
                                                ) {
                                                    cell = (
                                                        <form onSubmit={this.save}>
                                                            <input type="text" defaultValue={cell} />
                                                        </form>
                                                    );
                                                }
                                                return <td key={columnidx}>{cell}</td>;
                                            })}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>

                    </div>
                )
            }
        }

        Excel.propTypes = {
            headers: PropTypes.arrayOf(PropTypes.string),
            initialData: PropTypes.arrayOf(PropTypes.arrayOf(PropTypes.string)),
        };

        class MyPage extends React.Component {
            render() {
                return (
                    <div>
                        <h1>Excel</h1>
                        <Excel headers={headers} initialData={data} />
                    </div>
                )
            }
        }

        window.onload = function () {
            ReactDOM.render(
                // <StrictMode>
                <MyPage />
                // </StrictMode>
                ,
                document.getElementById('root')
            );
        };

    </script>
</body>

</html>